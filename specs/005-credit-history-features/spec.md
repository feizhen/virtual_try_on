# Feature Specification: Credit System and History Enhancements

**Feature Branch**: `005-credit-history-features`
**Created**: 2025-10-25
**Status**: Draft
**Input**: User description: "首先分析现有项目的功能,然后在现在项目功能的基础之上添加:1. 试衣重试功能 2. 重新上传模特图功能 3. 添加 credit 系统,每次生图需要消耗对应的 credit 4. 支持查看试衣历史记录"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Credit System Foundation (Priority: P1)

作为虚拟试衣应用的用户，我需要一个积分（credit）系统来管理我的试衣次数，这样平台可以控制资源使用并提供公平的服务。

**Why this priority**: Credit 系统是整个功能集的基础设施。所有其他功能（历史记录、重试）都依赖于 credit 的消耗和管理。没有 credit 系统，其他功能无法正常工作。

**Independent Test**: 可以通过注册新用户、检查初始 credit 余额、执行虚拟试衣并验证 credit 扣除来独立测试。该功能提供的价值是资源使用控制和用户配额管理。

**Acceptance Scenarios**:

1. **Given** 一个新注册的用户，**When** 用户首次登录系统，**Then** 用户账户应该有初始 credit 额度（例如 100 credits）
2. **Given** 用户有足够的 credit 余额（例如 50 credits），**When** 用户发起一次虚拟试衣请求，**Then** 系统应扣除相应的 credit（例如 10 credits），并在界面上显示更新后的余额
3. **Given** 用户的 credit 余额不足（例如只剩 5 credits），**When** 用户尝试发起需要 10 credits 的虚拟试衣，**Then** 系统应拒绝请求并提示用户余额不足
4. **Given** 用户正在查看个人资料页面，**When** 页面加载完成，**Then** 应清晰显示当前 credit 余额和 credit 使用历史记录
5. **Given** 虚拟试衣处理失败（AI 服务返回错误），**When** 系统检测到失败，**Then** 应退还已扣除的 credit 给用户，并通知退款原因

---

### User Story 2 - Try-On History Viewing (Priority: P2)

作为用户，我希望能够查看我的虚拟试衣历史记录，这样我可以回顾之前的试衣结果、对比不同的搭配，并轻松找到我喜欢的造型。

**Why this priority**: 历史记录功能为用户提供了重要的回顾和对比能力，是提升用户体验的关键功能。它也为后续的重试功能提供了基础数据来源。

**Independent Test**: 可以通过执行多次虚拟试衣、访问历史记录页面、验证记录完整性和排序来独立测试。该功能提供的价值是让用户能够追溯和管理他们的试衣历史。

**Acceptance Scenarios**:

1. **Given** 用户已完成至少一次虚拟试衣，**When** 用户访问历史记录页面，**Then** 应显示所有试衣记录，包括模特图、服装图、生成的结果图、处理时间和消耗的 credit
2. **Given** 用户查看历史记录列表，**When** 列表显示时，**Then** 记录应按时间倒序排列（最新的在最前面）
3. **Given** 用户有超过 20 条历史记录，**When** 访问历史记录页面，**Then** 应实现分页或无限滚动加载，避免一次性加载过多数据影响性能
4. **Given** 用户点击某条历史记录，**When** 记录详情页打开，**Then** 应显示该次试衣的所有详细信息，包括使用的模特图、服装图、生成的结果图、处理状态、处理时长、消耗的 credit 和创建时间
5. **Given** 用户的某次试衣处理失败，**When** 在历史记录中查看该记录，**Then** 应清晰标注失败状态、显示错误信息、并标明已退还的 credit
6. **Given** 用户想要删除某条历史记录，**When** 用户点击删除按钮并确认，**Then** 该记录应被软删除（不显示在列表中），但不会退还 credit（因为处理已执行）

---

### User Story 3 - Retry Failed Try-Ons (Priority: P3)

作为用户，当我的虚拟试衣因各种原因失败时，我希望能够轻松重试，而不需要重新上传图片和重新选择，这样可以节省我的时间并提高成功率。

**Why this priority**: 重试功能显著改善用户体验，特别是在 AI 服务不稳定或临时错误的情况下。它依赖于历史记录功能来获取之前的配置信息。

**Independent Test**: 可以通过故意触发失败场景（例如断开网络）、验证失败记录、执行重试操作并检查新的处理会话来独立测试。该功能提供的价值是减少用户挫败感和提高成功率。

**Acceptance Scenarios**:

1. **Given** 用户有一条状态为"失败"的试衣历史记录，**When** 用户在该记录上点击"重试"按钮，**Then** 系统应使用相同的模特图和服装图发起新的虚拟试衣请求
2. **Given** 用户点击重试按钮，**When** 重试请求发起前，**Then** 系统应先检查用户 credit 余额是否充足，余额不足时提示用户无法重试
3. **Given** 重试请求已发起，**When** 处理开始，**Then** 应扣除相应的 credit（与正常试衣相同的费用）
4. **Given** 用户有一条状态为"成功"的试衣历史记录，**When** 用户在该记录上点击"重新生成"按钮，**Then** 系统应允许用户使用相同配置重新生成（可能得到略微不同的结果），并扣除 credit
5. **Given** 重试或重新生成请求成功完成，**When** 处理完成，**Then** 应创建一条新的历史记录（而不是覆盖原记录），并在新记录中标注这是一次重试/重新生成

---

### User Story 4 - Re-upload Model Photo (Priority: P4)

作为用户，我希望能够替换之前上传的模特照片，这样我可以使用更好的照片或更新我的模特库，而不需要删除并重新上传。

**Why this priority**: 这是一个便利性功能，改善了图片管理体验，但不影响核心的试衣流程。可以在其他更关键功能稳定后实现。

**Independent Test**: 可以通过上传初始模特图、执行替换操作、验证新图片已保存和旧图片已清理来独立测试。该功能提供的价值是更灵活的图片管理。

**Acceptance Scenarios**:

1. **Given** 用户已上传至少一张模特照片，**When** 用户在模特图列表中选择某张照片并点击"替换"按钮，**Then** 应打开文件选择对话框，允许用户选择新的照片
2. **Given** 用户选择了新的照片文件，**When** 上传完成后，**Then** 旧的模特照片应被新照片替换，文件系统中的旧文件应被删除以节省存储空间
3. **Given** 某张模特照片曾被用于历史试衣记录，**When** 用户替换该照片，**Then** 历史记录中应仍然保留原始照片的引用（避免破坏历史数据的完整性），或者在历史记录中标注"原始模特图已更新"
4. **Given** 用户正在替换模特照片，**When** 上传新照片时，**Then** 应执行与初次上传相同的验证规则（文件大小 ≤ 10MB，格式为 JPEG/PNG/WebP）
5. **Given** 替换操作进行中，**When** 网络中断或上传失败，**Then** 系统应保留原照片不变，并提示用户替换失败

---

### Edge Cases

- **Credit 边界情况**：
  - 当用户 credit 恰好等于试衣费用时，能否成功发起请求？
  - 当多个请求几乎同时发起，而总 credit 不足时，如何处理并发扣费？
  - Credit 余额是否可以为负数？（应该不能）

- **历史记录边界**：
  - 用户删除了某张模特图或服装图后，相关的历史记录应如何显示？
  - 历史记录是否有数量上限？超过上限如何处理？
  - 历史记录的软删除是否可以恢复？

- **重试机制边界**：
  - 单条记录是否可以无限次重试？是否需要设置重试次数限制？
  - 如果原始的模特图或服装图已被用户删除，重试功能如何处理？
  - 重试是否支持修改参数（例如 seed 值）？

- **图片替换边界**：
  - 替换图片时，如果新图片的尺寸/比例与旧图片差异很大，是否需要警告？
  - 是否允许同时替换多张图片？
  - 图片替换后，正在进行的试衣任务（使用旧图片）是否应该取消？

- **系统错误处理**：
  - 如果 credit 扣除成功但试衣请求未能创建（系统崩溃），如何处理？
  - 如果试衣成功但 credit 退还逻辑失败（针对失败场景），如何保证数据一致性？

## Requirements *(mandatory)*

### Functional Requirements

#### Credit 系统
- **FR-001**: 系统必须为每个新注册用户分配初始 credit 额度（默认 100 credits）
- **FR-002**: 系统必须在每次虚拟试衣请求发起前检查用户的 credit 余额是否充足
- **FR-003**: 系统必须在虚拟试衣开始处理时立即扣除相应的 credit（默认每次试衣消耗 10 credits）
- **FR-004**: 系统必须在虚拟试衣处理失败时自动退还已扣除的 credit
- **FR-005**: 系统必须记录所有 credit 变更操作，包括扣除、退还、原因和时间戳
- **FR-006**: 用户界面必须在所有相关页面（个人资料、试衣页面）实时显示当前 credit 余额
- **FR-007**: 系统必须在 credit 余额不足时阻止用户发起新的试衣请求，并显示明确的错误提示
- **FR-008**: Credit 扣除和退还操作必须是原子性的（使用数据库事务），避免并发冲突导致余额错误

#### 历史记录系统
- **FR-009**: 系统必须记录所有虚拟试衣请求的完整信息，包括模特图 ID、服装图 ID、结果图 URL、处理状态、处理时长、消耗的 credit 和创建时间
- **FR-010**: 用户必须能够访问自己的所有历史记录，但不能查看其他用户的记录
- **FR-011**: 历史记录列表必须按时间倒序排列（最新的在前）
- **FR-012**: 历史记录列表必须支持分页或懒加载，每页显示 20 条记录
- **FR-013**: 用户必须能够查看单条历史记录的详细信息，包括所有相关图片的预览
- **FR-014**: 历史记录必须清晰标注处理状态（pending、processing、completed、failed）
- **FR-015**: 失败的历史记录必须显示错误信息和已退还的 credit 金额
- **FR-016**: 用户必须能够软删除自己的历史记录（记录在数据库中标记为已删除，但不实际删除）
- **FR-017**: 软删除的历史记录不应出现在用户的历史记录列表中

#### 重试功能
- **FR-018**: 用户必须能够对状态为"失败"或"成功"的历史记录执行重试/重新生成操作
- **FR-019**: 重试操作必须使用原历史记录中相同的模特图 ID 和服装图 ID
- **FR-020**: 重试操作必须在发起前检查用户 credit 余额，余额不足时拒绝请求
- **FR-021**: 重试操作必须扣除与正常试衣相同数量的 credit
- **FR-022**: 重试操作必须创建新的处理会话和新的历史记录，而不是修改原记录
- **FR-023**: 新创建的历史记录必须包含指向原记录的引用（例如 `retryFromId` 字段），方便追溯
- **FR-024**: 如果原历史记录引用的模特图或服装图已被删除，重试操作必须失败并提示用户"原始图片已不存在"

#### 模特图替换功能
- **FR-025**: 用户必须能够替换自己已上传的模特照片
- **FR-026**: 图片替换功能必须执行与初次上传相同的验证规则（文件大小 ≤ 10MB，格式为 JPEG/PNG/WebP，Magic Number 验证）
- **FR-027**: 替换成功后，系统必须删除旧的图片文件以节省存储空间
- **FR-028**: 系统必须保留历史记录中对旧图片的引用，确保历史数据的完整性（通过保留旧图片文件或在删除前检查引用）
- **FR-029**: 如果旧图片仍被历史记录引用，系统必须保留旧图片文件，不能删除
- **FR-030**: 替换操作失败时（网络错误、验证失败），必须保持原图片不变

### Key Entities

#### CreditTransaction (Credit 交易记录)
- 表示用户 credit 余额的每次变更操作
- 关键属性：
  - 交易 ID（唯一标识）
  - 用户 ID（关联到用户）
  - 交易类型（扣除、退还、初始分配、管理员调整）
  - 交易金额（正数表示增加，负数表示扣除）
  - 关联的试衣会话 ID（如果适用）
  - 交易原因/描述
  - 交易前余额、交易后余额（用于审计和对账）
  - 创建时间
- 与现有实体的关系：
  - 属于一个 User
  - 可能关联到一个 ProcessingSession（如果是试衣引起的交易）

#### User (扩展现有实体)
- 需要添加的新属性：
  - 当前 credit 余额（整数，默认 100）
  - 总计消费的 credit（用于统计）
  - 总计获得的 credit（用于统计）
  - Credit 更新时间

#### OutfitResult (扩展现有实体)
- 需要添加的新属性：
  - 消耗的 credit 数量（记录该次试衣消耗了多少 credit）
  - 是否为重试/重新生成（布尔值）
  - 重试来源 ID（如果是重试，指向原始的 OutfitResult ID）

#### ProcessingSession (扩展现有实体)
- 需要添加的新属性：
  - Credit 交易 ID（关联到扣除 credit 的交易记录）
  - Credit 退还交易 ID（如果失败并退还，关联到退还交易记录）

#### ModelPhoto (扩展现有实体)
- 需要添加的新属性：
  - 替换历史（JSON 字段，记录每次替换的时间和旧文件路径，用于审计）
  - 当前版本号（每次替换递增）

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户在发起试衣前能够清楚看到自己的 credit 余额，余额显示延迟不超过 1 秒
- **SC-002**: 当用户 credit 余额不足时，系统在 500 毫秒内阻止请求并显示明确的错误提示
- **SC-003**: Credit 扣除和退还操作的准确率达到 100%（无余额错误或遗漏）
- **SC-004**: 用户能够在 3 秒内加载历史记录页面并查看最近 20 条记录
- **SC-005**: 历史记录列表支持至少 1000 条记录的流畅浏览（通过分页/懒加载）
- **SC-006**: 用户可以在 2 次点击内完成重试操作（点击历史记录 → 点击重试按钮）
- **SC-007**: 重试成功率与正常试衣成功率相同（假设服务稳定）
- **SC-008**: 模特图替换操作在 5 秒内完成（包括上传、验证、文件替换）
- **SC-009**: 图片替换不会破坏现有历史记录的完整性（历史记录仍能显示原始图片或明确标注图片已更新）
- **SC-010**: 系统在高并发场景下（10 个用户同时发起试衣）不会出现 credit 余额计算错误
- **SC-011**: 90% 的用户能够在首次使用时理解 credit 系统的工作原理（通过界面提示和余额显示）
- **SC-012**: 历史记录功能使用户能够快速找到之前的试衣结果，减少重复试衣次数（预期减少 30%）

## Assumptions

1. **Credit 定价**：假设每次虚拟试衣消耗 10 credits，初始赠送 100 credits（可支持 10 次试衣）。未来可能需要支持不同复杂度的试衣有不同的 credit 消耗。
2. **Credit 充值**：当前版本不包含 credit 充值功能（购买 credit），用户只能使用初始赠送的 credit。充值功能留待后续版本实现。
3. **历史记录保留期**：假设历史记录永久保留（除非用户手动删除），不会自动清理旧记录。
4. **图片存储策略**：当模特图或服装图被替换时，如果旧图片仍被历史记录引用，则保留旧图片文件；否则删除以节省空间。
5. **重试不修改参数**：重试操作使用完全相同的参数（模特图、服装图），不允许修改。如果需要修改参数，用户应发起新的试衣请求。
6. **并发控制**：使用数据库事务和行级锁来确保 credit 操作的原子性和一致性。
7. **错误通知**：当试衣失败并退还 credit 时，通过界面通知用户，不发送邮件或其他外部通知（可在后续版本添加）。
8. **软删除策略**：历史记录采用软删除（标记 deletedAt 字段），不物理删除数据库记录，以支持可能的数据恢复和审计需求。

## Dependencies

- **现有虚拟试衣流程**：Credit 系统和历史记录功能依赖于现有的虚拟试衣处理流程（OutfitChangeService、ProcessingSession、OutfitResult）。
- **认证系统**：所有功能都需要用户已登录（依赖现有的 JWT 认证）。
- **数据库**：需要扩展现有的 Prisma schema，添加新的 CreditTransaction 模型和扩展现有模型的字段。
- **文件存储系统**：图片替换功能依赖现有的 StorageService 来管理文件的保存和删除。

## Out of Scope

以下功能不在本次实现范围内，可能在未来版本中考虑：

- **Credit 充值/购买功能**：用户无法通过付费方式获取更多 credit。
- **Credit 赠送/转账**：用户之间不能互相转让 credit。
- **管理员 Credit 管理后台**：管理员无法通过后台界面为用户调整 credit（需要直接操作数据库）。
- **积分等级/会员系统**：不同等级用户享受不同的 credit 优惠或折扣。
- **历史记录高级筛选**：按日期范围、状态、服装类型等条件筛选历史记录。
- **历史记录导出**：导出历史记录为 PDF 或 CSV 文件。
- **收藏/标记功能**：用户无法收藏或标记喜欢的试衣结果。
- **批量重试**：一次性重试多条失败记录。
- **服装图替换**：本次只实现模特图替换，服装图替换留待后续版本（可复用相同逻辑）。

