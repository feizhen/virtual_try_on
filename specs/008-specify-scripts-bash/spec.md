# Feature Specification: TOS 图片云存储迁移

**Feature Branch**: `008-specify-scripts-bash`
**Created**: 2025-10-29
**Status**: Draft
**Input**: User description: "了解现在项目,我想把现在的图片上传保存到 TOS 服务器,帮我做选型和实现规划"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用户上传图片至云端存储 (Priority: P1)

用户上传模特照片或衣服照片时,图片被安全地保存到火山引擎 TOS 云存储,并能够通过 CDN 快速访问。用户无需感知底层存储方式的变化,上传体验与之前一致。

**Why this priority**: 这是核心功能,必须首先实现。云存储是后续所有功能(CDN加速、分布式部署)的基础。如果这个功能失败,整个特性将无法工作。

**Independent Test**: 可以通过上传一张新图片并验证它被成功保存到 TOS 存储桶来独立测试。验证方式:检查数据库记录中的 imageUrl 包含 TOS 路径,且通过返回的 URL 能访问到图片。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统, **When** 用户在虚拟试衣页面上传一张模特照片(JPEG,5MB), **Then** 图片被成功上传到 TOS,返回的 URL 可以正常访问,且数据库记录显示 TOS 存储路径
2. **Given** 用户已登录系统, **When** 用户上传一张衣服照片(PNG,3MB), **Then** 图片被成功保存到 TOS 的 clothing 子目录,前端展示上传成功状态
3. **Given** 系统正在处理上传, **When** 上传过程中显示进度条, **Then** 进度条准确反映上传到 TOS 的实时进度

---

### User Story 2 - 访问已上传的图片 (Priority: P1)

用户能够查看和使用之前上传到云存储的所有图片,包括在图片库中浏览、选择用于虚拟试衣、以及查看历史试衣结果。图片加载速度快且稳定。

**Why this priority**: 与上传同等重要,是用户完整工作流的必要环节。没有可靠的图片访问,上传功能将失去意义。

**Independent Test**: 可以通过访问用户的图片库列表并点击查看大图来独立测试。验证方式:所有图片 URL 指向 TOS,图片能快速加载,列表中显示正确的缩略图。

**Acceptance Scenarios**:

1. **Given** 用户已上传多张模特照片, **When** 用户打开模特照片库, **Then** 所有图片缩略图快速加载(2秒内),且来自 TOS CDN
2. **Given** 用户在图片库中, **When** 用户点击某张图片查看大图, **Then** 大图从 TOS 加载并完整显示,支持缩放和查看细节
3. **Given** 用户查看历史试衣记录, **When** 用户打开某条历史记录, **Then** 原始照片和结果图片都能正常加载显示

---

### User Story 3 - 处理上传失败和重试 (Priority: P2)

当上传到 TOS 失败时(网络问题、服务器故障、认证失败),系统向用户显示清晰的错误信息,并提供重试选项。用户可以快速重新上传失败的图片。

**Why this priority**: 提升用户体验和系统可靠性,但不影响核心功能。可以在基础上传功能稳定后再完善错误处理。

**Independent Test**: 可以通过模拟网络故障或 TOS 服务异常来独立测试。验证方式:触发上传错误,检查是否显示友好错误消息和重试按钮,重试后能成功上传。

**Acceptance Scenarios**:

1. **Given** TOS 服务暂时不可用, **When** 用户尝试上传图片, **Then** 系统显示 "云存储服务暂时不可用,请稍后重试" 的错误消息,并提供重试按钮
2. **Given** 用户网络连接不稳定, **When** 上传过程中网络中断, **Then** 系统检测到上传失败,显示错误并允许用户重新上传
3. **Given** TOS 认证凭证过期, **When** 系统尝试上传文件, **Then** 后端自动刷新凭证并重试,如果仍失败则返回明确错误信息

---

### User Story 4 - 删除云端图片 (Priority: P2)

用户删除图片时,系统同时删除数据库记录和 TOS 上的实际文件,避免浪费存储空间和产生额外费用。已被历史记录引用的图片被标记为删除而非物理删除。

**Why this priority**: 重要但不紧急。初期可以接受软删除不清理 TOS 文件,后续再实现定期清理任务。

**Independent Test**: 可以通过删除一张未使用的图片并检查 TOS 存储桶来独立测试。验证方式:数据库记录被软删除,TOS 上的文件也被删除(通过 URL 访问返回 404)。

**Acceptance Scenarios**:

1. **Given** 用户有一张未使用的模特照片, **When** 用户删除该照片, **Then** 数据库记录标记为已删除,TOS 上的文件也被删除
2. **Given** 用户有一张已用于历史试衣的照片, **When** 用户删除该照片, **Then** 数据库记录软删除但文件保留在 TOS,确保历史记录仍可访问
3. **Given** 系统执行定期清理任务, **When** 任务扫描到已软删除超过30天且无引用的图片, **Then** 系统批量删除这些 TOS 文件并记录清理日志

---

### User Story 5 - 替换已上传的图片 (Priority: P3)

用户可以替换已上传的模特照片或衣服照片,系统会将旧文件归档到 TOS 的归档目录(如果被引用)或直接删除(如果未被引用),并上传新文件。

**Why this priority**: 优化功能,提升用户体验,但不影响核心流程。用户可以先删除再上传来达到类似效果。

**Independent Test**: 可以通过选择一张已上传的图片并点击 "替换" 按钮来独立测试。验证方式:新图片上传到 TOS,旧图片根据引用情况被归档或删除,数据库记录更新。

**Acceptance Scenarios**:

1. **Given** 用户有一张未被使用的模特照片, **When** 用户上传新图片替换它, **Then** 旧图片从 TOS 删除,新图片上传成功,数据库记录更新
2. **Given** 用户有一张已用于历史试衣的照片, **When** 用户替换该照片, **Then** 旧图片归档到 TOS archived 目录,新图片上传,版本号递增
3. **Given** 用户正在替换图片, **When** 新图片上传到 TOS 的50%时, **Then** 进度条显示当前进度,用户可以看到实时上传状态

---

### Edge Cases

- **上传超大文件**: 用户尝试上传超过 10MB 的图片时,前端在上传前进行验证并拒绝,显示 "图片大小不能超过 10MB" 的错误消息
- **并发上传**: 用户同时上传多张图片时,系统并发处理上传请求,每个请求独立追踪进度,不会相互影响
- **TOS 存储空间不足**: 当 TOS 存储桶空间接近配额时,系统发送告警通知管理员,用户上传失败时显示友好错误消息
- **图片格式边缘情况**: 用户上传的图片虽然扩展名是 .jpg 但实际是 PNG 格式时,系统通过魔数验证检测到不匹配并拒绝上传
- **TOS 认证失败**: 当 TOS AccessKey 或 SecretKey 配置错误时,系统记录详细错误日志,返回给用户的错误消息不暴露敏感信息
- **网络超时**: 上传大文件时如果网络超时(超过2分钟),系统终止请求并提示用户检查网络连接后重试
- **特殊字符文件名**: 用户上传的原始文件名包含特殊字符或中文时,系统使用 UUID 生成唯一文件名,在数据库中保留原始文件名供显示使用
- **重复上传相同文件**: 用户重复上传同一张图片时,系统生成新的 UUID 文件名并创建独立的数据库记录,不会覆盖旧文件

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持将用户上传的图片保存到火山引擎 TOS 对象存储服务
- **FR-002**: 系统必须支持三种类型图片的云存储:模特照片(models/)、衣服照片(clothing/)、试衣结果(results/)
- **FR-003**: 系统必须在上传前验证图片文件:类型(JPEG/PNG/WebP)、大小(≤10MB)、魔数验证
- **FR-004**: 系统必须为每个上传文件生成全局唯一的文件名(UUID + 原始扩展名)
- **FR-005**: 系统必须将 TOS 文件的访问 URL 保存到数据库,并返回给前端用于展示
- **FR-006**: 系统必须支持通过 CDN 加速访问 TOS 存储的图片
- **FR-007**: 系统必须在用户删除图片时标记数据库记录为软删除,并根据引用情况决定是否删除 TOS 文件
- **FR-008**: 系统必须支持替换已上传的图片,旧文件根据是否被引用决定归档或删除
- **FR-009**: 系统必须在上传过程中向前端报告实时进度(百分比)
- **FR-010**: 系统必须妥善处理 TOS 上传失败,返回明确的错误信息给前端,不暴露敏感配置
- **FR-011**: 系统必须使用环境变量管理 TOS 配置:Endpoint、Region、Bucket、AccessKey、SecretKey
- **FR-012**: 系统必须保持与现有本地存储方案的兼容性,通过配置开关控制存储方式(本地/TOS)
- **FR-013**: 系统必须在 ModelPhoto、ClothingItem、OutfitResult 表中存储 TOS 文件路径和访问 URL
- **FR-014**: 系统必须支持批量删除操作,允许管理员清理 TOS 中已软删除且无引用的文件
- **FR-015**: 系统必须记录 TOS 操作日志:上传成功/失败、删除操作、错误详情

### Key Entities *(include if feature involves data)*

- **TOS 存储文件**: 代表保存在火山引擎 TOS 对象存储中的图片文件,属性包括:文件路径(key)、访问 URL、文件大小、MIME类型、上传时间
- **存储配置**: 代表 TOS 服务的连接配置,属性包括:Endpoint(服务端点)、Region(区域)、Bucket(存储桶名称)、AccessKey(访问密钥)、SecretKey(密钥)、CDN域名
- **图片记录**: 现有的 ModelPhoto、ClothingItem、OutfitResult 实体,新增属性:storageType(存储类型:local/tos)、tosKey(TOS文件路径)、cdnUrl(CDN加速URL)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户上传图片的成功率达到 99.5% 以上(排除用户网络问题)
- **SC-002**: 用户访问图片库时,缩略图完全加载时间不超过 2 秒(通过 CDN 加速)
- **SC-003**: 用户上传单张图片(5MB)的总耗时不超过 10 秒(包括上传到 TOS 和数据库记录)
- **SC-004**: 系统支持至少 50 个用户同时上传图片而不出现性能降级
- **SC-005**: TOS 存储成本相比本地存储降低至少 30%(考虑服务器存储扩容成本)
- **SC-006**: 图片删除后,TOS 文件在 24 小时内被清理(针对无引用的文件)
- **SC-007**: 所有 TOS 操作失败都能返回用户友好的错误消息,无技术细节泄露
- **SC-008**: 系统能够无缝切换本地存储和 TOS 存储,切换过程中不影响现有用户数据访问

## Assumptions

1. **TOS 服务可用性**: 假设火山引擎 TOS 服务的可用性 SLA 为 99.9% 以上,满足业务需求
2. **认证方式**: 使用 AccessKey/SecretKey 的方式进行 TOS 认证,不使用临时凭证(STS)
3. **存储桶权限**: TOS 存储桶已创建并配置为私有读写,通过签名 URL 或 CDN 域名公开访问
4. **图片格式**: 继续支持现有的三种图片格式(JPEG、PNG、WebP),不新增其他格式
5. **文件大小限制**: 保持 10MB 的单文件大小限制,不调整
6. **CDN 配置**: 假设 TOS 存储桶已绑定 CDN 域名,用于加速图片访问
7. **数据迁移**: 现有本地存储的历史图片不立即迁移到 TOS,仅新上传文件使用 TOS,历史文件按需迁移
8. **存储路径结构**: TOS 中使用与本地存储相同的目录结构:models/、clothing/、results/
9. **并发控制**: TOS SDK 自带的连接池和并发控制机制足以处理业务并发需求
10. **错误重试**: TOS SDK 内置的自动重试机制(网络错误、5xx错误)满足需求,不需要应用层额外实现

## Dependencies

- **火山引擎 TOS 账号**: 需要拥有有效的火山引擎账号并开通 TOS 对象存储服务
- **TOS SDK**: 需要集成火山引擎官方的 Node.js TOS SDK(@volcengine/tos-sdk)
- **存储桶创建**: 需要预先在 TOS 控制台创建存储桶并配置权限策略
- **CDN 配置**: 需要为 TOS 存储桶绑定 CDN 加速域名,并完成域名备案和 CNAME 配置
- **环境变量**: 需要在服务器环境中配置 TOS 相关环境变量(Endpoint、Region、Bucket、AccessKey、SecretKey、CDN域名)
- **现有模块**: 依赖现有的 StorageService、OutfitChangeService、DatabaseModule

## Non-functional Requirements

### 性能要求

- 上传 5MB 图片到 TOS 的 P95 延迟不超过 8 秒
- 通过 CDN 访问图片的首字节时间(TTFB)不超过 200ms
- 系统支持每秒至少 10 个并发上传请求

### 安全要求

- TOS AccessKey 和 SecretKey 必须通过环境变量配置,不得硬编码在代码中
- TOS 存储桶必须配置为私有访问,公开访问通过签名 URL 或 CDN 域名
- 上传的文件路径和文件名不得包含用户可控的路径遍历字符
- 错误日志中不得记录完整的 AccessKey 或 SecretKey

### 可维护性要求

- 通过配置开关(环境变量 STORAGE_TYPE)控制使用本地存储或 TOS,方便回滚
- TOS 操作必须有详细的日志记录,包括操作类型、文件路径、耗时、错误信息
- 代码需要抽象存储接口,支持未来切换到其他云存储服务(如 AWS S3、阿里云 OSS)

### 可扩展性要求

- 存储服务设计需支持多区域部署(不同地区使用不同 TOS Bucket)
- 支持配置多个 CDN 域名用于负载均衡或故障转移
- 预留接口支持未来实现图片压缩、缩略图生成等功能

## Out of Scope

本次特性**不包括**以下内容:

- 历史图片的批量迁移工具(从本地存储迁移到 TOS)
- 图片自动压缩和格式转换功能
- 自动生成多种尺寸缩略图
- 图片内容安全审核(鉴黄、敏感信息检测)
- TOS 存储成本分析和报表功能
- 支持视频文件上传和存储
- 跨云存储的自动同步和备份
- 图片水印添加功能

